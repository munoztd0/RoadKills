---
title: "RoadKills"
author: "David Munoz Tord"
date: today
format:
  html:
    code-fold: true
    code-tools: true
    code-link: true
editor_options: 
  chunk_output_type: console
---


## Notes
Carte des points noir (avec dommage materiel) par cluster dernier 5 ans canton


Autoroutes: traffic induit

checker amenagement avec Rob (chemin) -\> SITG


## Intro

```{r}
#| label: setup 
#| echo: false
#| message: false

knitr::opts_chunk$set(echo = T, message = FALSE, warning = FALSE)


options(
  warn = -1,
  quarto.hunk.opts = list(
    context = 2,
    color = TRUE,
    collapse = TRUE,
    style = "github"
  )
)


library(tidyverse)
library(janitor)
library(plotly)
library(rgdal)
library(leaflet)

```

```{r}
#| label: load data
#| echo: false
#| message: false

# the data is downloaded from the SITG website
#https://ge.ch/sitg/geodata/SITG/OPENDATA/8139/CSV_OTC_ACCIDENTS.zip



OTC_ACCIDENTS <- read_delim("data/CSV_OTC_ACCIDENTS/OTC_ACCIDENTS.csv", 
    delim = ",", escape_double = FALSE, trim_ws = TRUE) |>
  janitor::clean_names() |>
  mutate(date = as.Date(as.character(date), format = "%Y%m%d")) #change date format from double like 20100616 to date




# Now we project the coordinates to WGS84

myConvert_LV95_to_WGS84 = function(df) {
    coordinates(df) = ~ long + lat
    df@proj4string = CRS("+init=epsg:2056")
    myCoords_WGS84 = spTransform(df, CRS("+init=epsg:4326"))
    myCoords_WGS84@coords
}

OTC_ACCIDENTS_GPS <- OTC_ACCIDENTS |> 
  select(long=coor_x, lat=coor_y) |> 
  myConvert_LV95_to_WGS84() |> 
  bind_cols(OTC_ACCIDENTS) 


```

```{r}
#| label:  creating columns


# we just gonna  merge  nb_bicyclettes and  nb_vae_25
OTC_ACCIDENTS_GPS |>
    mutate(velo = nb_bicyclettes) |>
    mutate(velo_lent = nb_bicyclettes + nb_vae_25) |>
    mutate(velo_25 = nb_vae_25) |>
    mutate(velo_45 = nb_vae_45) |>
    mutate(velo_elec = nb_vae_25 + nb_vae_45) |>
    mutate(velo_tous = velo_lent + nb_vae_45) |>
    mutate(pietons = nb_pietons)  |> 
    write_csv("data/App/data/data.csv")
```

```{r}
#| label:  first map

#read "data/CSV_OTC_ACCIDENTS/OTC_ACCIDENTS_GPS.csv"
OTC_ACCIDENTS_GPS <- readr::read_csv("data/CSV_OTC_ACCIDENTS/OTC_ACCIDENTS_GPS.csv")


OTC_ACCIDENTS_GPS |>
  as.data.frame() |>
  filter(annee == 2022) |>
  filter(nb_bicyclettes > 0) |>
  leaflet() |>
  addTiles()|>
  addMarkers(~long, ~lat) #, #label=~as.character(AccidentSeverityCategory_en))

```
